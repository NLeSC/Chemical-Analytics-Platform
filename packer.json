{
    "variables": {
        "ssh_name": "vagrant",
        "ssh_pass": "vagrant"
    },
    "builders": [{
        "type": "virtualbox-iso",
        "guest_os_type": "Ubuntu_64",
        "iso_url": "http://de.releases.ubuntu.com/16.04/ubuntu-16.04.1-server-amd64.iso",
        "iso_checksum": "29a8b9009509b39d542ecb229787cdf48f05e739a932289de9e9858d7c487c80",
        "iso_checksum_type": "sha256",
        "ssh_username": "{{user `ssh_name`}}",
        "ssh_password": "{{user `ssh_pass`}}",
        "shutdown_command": "echo {{user `ssh_pass`}} | sudo -S shutdown -P now",
        "guest_additions_mode": "disable",
        "boot_wait": "5s",
        "http_directory": ".",
        "boot_command": [
            "<enter><wait><f6><esc><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
            "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
            "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
            "<bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
            "/install/vmlinuz ",
            "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg ",
            "debian-installer=en_US auto locale=en_US kbd-chooser/method=us ",
            "hostname={{.Name}} ",
            "fb=false debconf/frontend=noninteractive ",
            "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA ",
            "keyboard-configuration/variant=USA console-setup/ask_detect=false ",
            "initrd=/install/initrd.gz -- <enter>"
        ],
        "vboxmanage": [
            ["modifyvm", "{{.Name}}", "--cpus", "4"],
            ["modifyvm", "{{.Name}}", "--memory", "4096"],
            ["modifyvm", "{{.Name}}", "--clipboard", "bidirectional"],
            ["modifyvm", "{{.Name}}", "--draganddrop", "bidirectional"],
            ["modifyvm", "{{.Name}}", "--accelerate3d", "on"],
            ["modifyvm", "{{.Name}}", "--vram", "128"]
        ],
        "vboxmanage_post": [
            ["modifyvm", "{{.Name}}", "--cpus", "2"],
            ["modifyvm", "{{.Name}}", "--memory", "2048"]
        ],
        "disk_size": 60000,
        "format": "ova",
        "vm_name": "cap"
    }, {
        "type": "docker",
        "image": "ubuntu:16.04",
        "commit": true,
        "changes": [
            "EXPOSE 6080",
            "EXPOSE 5901",
            "VOLUME /vagrant",
            "ENTRYPOINT /entrypoint.sh",
            "HEALTHCHECK --interval=5m --timeout=3s CMD curl -f http://localhost:6080/ || exit 1"
        ]
    }],
    "provisioners": [{
        "type": "shell",
        "inline": [
            "apt-get update",
            "apt-get install -y python-pip python-dev libffi-dev libssl-dev sudo",
            "pip install ansible==2.0.2.0",
            "echo '{{user `ssh_name`}} ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers"
        ],
        "override": {
            "virtualbox-iso": {
                "execute_command": "echo {{user `ssh_pass`}} | {{ .Vars }} sudo -E -S sh '{{ .Path }}'"
            }
        }
    }, {
        "type": "ansible-local",
        "extra_arguments": ["--become", "--extra-vars", "build_type={{ build_type }}"],
        "playbook_file": "playbook.yml",
        "role_paths": [
            "roles/bootstrap", "roles/fpocket", "roles/knime", "roles/lxde",
            "roles/novnc", "roles/entrypoint",
            "roles/r", "roles/self-upgrade", "roles/virtualbox-guest-additions", "roles/wiki",
            "roles/postgresql", "roles/rdkit", "roles/chembl", "roles/chemtools", "roles/cleanup"
        ]
    }, {
        "type": "shell",
        "execute_command": "echo {{user `ssh_pass`}} | {{ .Vars }} sudo -E -S sh '{{ .Path }}'",
        "inline": ["shutdown -r now", "sleep 60"],
        "skip_clean": false,
        "only": ["virtualbox-iso"]
    }, {
        "_comment": "Asible provisioner is repeated because a reboot can be triggered to activate the new kernel",
        "type": "ansible-local",
        "pause_before": "20s",
        "extra_arguments": ["--become", "--extra-vars", "run_zerofree=True build_type={{ build_type }}"],
        "playbook_file": "playbook.yml",
        "role_paths": [
            "roles/bootstrap", "roles/fpocket", "roles/knime", "roles/lxde",
            "roles/novnc", "roles/entrypoint",
            "roles/r", "roles/self-upgrade", "roles/virtualbox-guest-additions", "roles/wiki",
            "roles/postgresql", "roles/rdkit", "roles/chembl", "roles/chemtools", "roles/cleanup"
        ],
        "only": ["virtualbox-iso"]
    }],
    "post-processors": [{
        "type": "vagrant",
        "vagrantfile_template": "Vagrantfile.tpl",
        "keep_input_artifact": true,
        "only": ["virtualbox-iso"]
    }, {
        "type": "docker-tag",
        "repository": "3dechem/3dechem",
        "tag": "latest",
        "only": ["docker"]
    }]
}
